name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3.3.0
      - uses: dart-lang/setup-dart@v1.4
      - run: dart pub global activate melos 2.3.1 && melos bs
      - run: melos exec --depends-on="build_runner" --fail-fast -- "dart run build_runner build --delete-conflicting-outputs"
      - run: melos exec --fail-fast -- "../../tool/ensure_git_clean.sh"
      - run: melos exec --fail-fast -- "dart format --output=none --set-exit-if-changed ."
      - uses: invertase/github-action-dart-analyzer@v1
        with:
          working-directory: packages/test_track
      - uses: invertase/github-action-dart-analyzer@v1
        with:
          working-directory: packages/test_track_test_support
      - run: melos exec -c 1 --fail-fast -- "../../tool/generate_code_coverage.sh"
      - uses: codecov/codecov-action@v2
        with:
          files: coverage/lcov.info
          working-directory: packages/test_track
      - uses: codecov/codecov-action@v2
        with:
          files: coverage/lcov.info
          working-directory: packages/test_track_test_support

  pana:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3.3.0
        - uses: dart-lang/setup-dart@v1.4
        - run: |
            dart pub global activate melos 2.3.1 && melos bs
            dart pub global activate pana
        - run: melos exec -- "../../tool/verify_pub_score.sh 110"
